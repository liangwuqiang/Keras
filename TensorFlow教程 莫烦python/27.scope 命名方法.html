<!DOCTYPE html>
    <html><head><meta charset="UTF-8">
    </head><body>
    <p><a href="https://morvanzhou.github.io/tutorials/machine-learning/tensorflow/">原文链接</a></p>
        <div class="tut-main-content-pad">
<hr>
<h1>scope 命名方法</h1>
<p style="text-align: center;">
        
          作者: <strong>莫烦</strong>   
        
        编辑: <strong>莫烦</strong>   
        
          2016-11-25
        
      </p>
<p>学习资料:</p>
<ul>
<li>不同 scope <a href="https://github.com/MorvanZhou/tutorials/blob/master/tensorflowTUT/tf22_scope/tf22_scope.py">对比代码</a></li>
<li>为 TF 2017 打造的<a href="https://github.com/MorvanZhou/Tensorflow-Tutorial">新版可视化教学代码</a></li>
<li>reuse variable <a href="https://github.com/MorvanZhou/tutorials/blob/master/tensorflowTUT/tf22_scope/tf22_RNN_scope.py">RNN 代码</a></li>
<li>sharing variable <a href="https://www.tensorflow.org/versions/master/how_tos/variable_scope/index.html">tensorflow 官网介绍</a></li>
</ul>
<p>scope 能让你命名变量的时候轻松很多. 同时也会在 reusing variable 代码中常常见到. 所以今天我们会来讨论下 tensorflow 当中的两种定义 scope 的方式. 
最后并附加一个 RNN 运用 reuse variable 的例子.</p>
<h4 class="tut-h4-pad" id="tf.name_scope()">tf.name_scope()</h4>
<p>在 Tensorflow 当中有两种途径生成变量 variable, 一种是 <code class="highlighter-rouge">tf.get_variable()</code>, 另一种是 <code class="highlighter-rouge">tf.Variable()</code>. 
如果在 <code class="highlighter-rouge">tf.name_scope()</code> 的框架下使用这两种方式, 结果会如下.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s">"a_name_scope"</span><span class="p">):</span>
    <span class="n">initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">var1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var1'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">)</span>
    <span class="n">var2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var2'</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">var21</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var2'</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">[</span><span class="mf">2.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">var22</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var2'</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">[</span><span class="mf">2.2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">initialize_all_variables</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>        <span class="c"># var1:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span>   <span class="c"># [ 1.]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>        <span class="c"># a_name_scope/var2:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var2</span><span class="p">))</span>   <span class="c"># [ 2.]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var21</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>       <span class="c"># a_name_scope/var2_1:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var21</span><span class="p">))</span>  <span class="c"># [ 2.0999999]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var22</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>       <span class="c"># a_name_scope/var2_2:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var22</span><span class="p">))</span>  <span class="c"># [ 2.20000005]</span>
</code></pre>
</div>
<p>可以看出使用 <code class="highlighter-rouge">tf.Variable()</code> 定义的时候, 虽然 <code class="highlighter-rouge">name</code> 都一样, 但是为了不重复变量名, Tensorflow 输出的变量名并不是一样的. 
所以, 本质上 <code class="highlighter-rouge">var2</code>, <code class="highlighter-rouge">var21</code>, <code class="highlighter-rouge">var22</code> 并不是一样的变量. 而另一方面, 使用<code class="highlighter-rouge">tf.get_variable()</code>定义的变量不会被<code class="highlighter-rouge">tf.name_scope()</code>当中的名字所影响.</p>
<h4 class="tut-h4-pad" id="tf.variable_scope()">tf.variable_scope()</h4>
<p>如果想要达到重复利用变量的效果, 我们就要使用 <code class="highlighter-rouge">tf.variable_scope()</code>, 并搭配 <code class="highlighter-rouge">tf.get_variable()</code> 这种方式产生和提取变量.
不像 <code class="highlighter-rouge">tf.Variable()</code> 每次都会产生新的变量, <code class="highlighter-rouge">tf.get_variable()</code> 如果遇到了同样名字的变量时, 它会单纯的提取这个同样名字的变量(避免产生新变量).
而在重复使用的时候, 一定要在代码中强调 <code class="highlighter-rouge">scope.reuse_variables()</code>, 否则系统将会报错, 以为你只是单纯的不小心重复使用到了一个变量.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s">"a_variable_scope"</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
    <span class="n">initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">var3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var3'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">)</span>
    <span class="n">scope</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>
    <span class="n">var3_reuse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var3'</span><span class="p">,)</span>
    <span class="n">var4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var4'</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">var4_reuse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'var4'</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var3</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="c"># a_variable_scope/var3:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var3</span><span class="p">))</span>       <span class="c"># [ 3.]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var3_reuse</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>      <span class="c"># a_variable_scope/var3:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var3_reuse</span><span class="p">))</span> <span class="c"># [ 3.]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var4</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>            <span class="c"># a_variable_scope/var4:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var4</span><span class="p">))</span>       <span class="c"># [ 4.]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">var4_reuse</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>      <span class="c"># a_variable_scope/var4_1:0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">var4_reuse</span><span class="p">))</span> <span class="c"># [ 4.]</span>
    
</code></pre>
</div>
<h4 class="tut-h4-pad" id="RNN应用例子">RNN应用例子</h4>
<p>RNN 例子的代码在<a href="https://github.com/MorvanZhou/tutorials/blob/master/tensorflowTUT/tf22_scope/tf22_RNN_scope.py">这里</a>, 整个 RNN 的结构已经在这里定义好了.
在 training RNN 和 test RNN 的时候, RNN 的 <code class="highlighter-rouge">time_steps</code> 会有不同的取值, 这将会影响到整个 RNN 的结构, 所以导致在 test 的时候, 不能单纯地使用 training 时建立的那个 RNN. 
但是 training RNN 和 test RNN 又必须是有同样的 weights biases 的参数. 所以, 这时, 就是使用 reuse variable 的好时机.</p>
<p>首先定义training 和 test 的不同参数.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainConfig</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">input_size</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">output_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">cell_size</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span>


<span class="k">class</span> <span class="nc">TestConfig</span><span class="p">(</span><span class="n">TrainConfig</span><span class="p">):</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="mi">1</span>
    
<span class="n">train_config</span> <span class="o">=</span> <span class="n">TrainConfig</span><span class="p">()</span>
<span class="n">test_config</span> <span class="o">=</span> <span class="n">TestConfig</span><span class="p">()</span>
</code></pre>
</div>
<p>然后让 <code class="highlighter-rouge">train_rnn</code> 和 <code class="highlighter-rouge">test_rnn</code> 在同一个 <code class="highlighter-rouge">tf.variable_scope('rnn')</code> 之下.
并且定义 <code class="highlighter-rouge">scope.reuse_variables()</code>, 使我们能把 <code class="highlighter-rouge">train_rnn</code> 的所有 weights, biases 参数全部绑定到 <code class="highlighter-rouge">test_rnn</code> 中.
这样, 不管两者的 <code class="highlighter-rouge">time_steps</code> 有多不同, 结构有多不同, <code class="highlighter-rouge">train_rnn</code> W, b 参数更新成什么样, <code class="highlighter-rouge">test_rnn</code> 的参数也更新成什么样.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s">'rnn'</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">train_rnn</span> <span class="o">=</span> <span class="n">RNN</span><span class="p">(</span><span class="n">train_config</span><span class="p">)</span>
    <span class="n">scope</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>
    <span class="n">test_rnn</span> <span class="o">=</span> <span class="n">RNN</span><span class="p">(</span><span class="n">test_config</span><span class="p">)</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
</code></pre>
</div>
<p style="font-size: 0.8em; padding:4em 1em 0.5em 1em; margin: 0 auto;">
        如果你觉得这篇文章或视频对你的学习很有帮助, 请你也分享它, 让它能再次帮助到更多的需要学习的人.

        莫烦没有正式的经济来源, 如果你也想支持 <strong>莫烦Python</strong> 并看到更好的教学内容, 赞助他一点点, 作为鼓励他继续开源的动力.
      </p>
<!-- donation -->
<div id="bottom-donation-section">
<h3 id="bottom-donation-title">支持 让教学变得更优秀</h3>
<br>
<div>
<a href="/support/" id="bottom-donation-button"><strong>点我 赞助 莫烦</strong></a>
</div>
<br>
</br></br></div>
<hr>
</hr></hr></div>
    </body></html>